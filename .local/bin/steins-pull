#!/usr/bin/env bash
set -euo pipefail

say(){ printf "\033[1;36m[SG-PULL]\033[0m %s\n" "$*"; }
ok(){ printf "\033[1;32m✔\033[0m %s\n" "$*"; }
warn(){ printf "\033[1;33m⚠\033[0m %s\n" "$*"; }

BACKUP_DIR="$HOME/Backups/SteinsGateOS"
REPO_DIR="$HOME/SteinsGateOS"

# Priority 1: Git repo
if [ -d "$REPO_DIR/.git" ]; then
    say "Pulling latest from git repo…"
    ( cd "$REPO_DIR" && git pull --rebase || warn "Git pull failed" )
    SRC="$REPO_DIR"
# Priority 2: Most recent tarball
elif ls -1t "$BACKUP_DIR"/sgos-*.tar.gz >/dev/null 2>&1; then
    LATEST="$(ls -1t "$BACKUP_DIR"/sgos-*.tar.gz | head -n 1)"
    say "Using latest tarball: $LATEST"
    mkdir -p /tmp/sgos_restore
    tar -xzf "$LATEST" -C /tmp/sgos_restore
    SRC="/tmp/sgos_restore"
else
    warn "No backups found in $REPO_DIR or $BACKUP_DIR."
    exit 1
fi

say "Restoring configs…"
rsync -a "$SRC/." "$HOME/"

ok "Restore complete."

# Reapply HUD autostart
if [ -f "$HOME/.config/conky/steinsgate.conf" ]; then
    pkill -x conky || true
    nohup conky -c "$HOME/.config/conky/steinsgate.conf" >/dev/null 2>&1 &
    ok "HUD restarted."
fi

# Reload bashrc to get aliases back
if [ -f "$HOME/.bashrc" ]; then
    source "$HOME/.bashrc"
    ok "Aliases reloaded."
fi

say "Lab Mode is back. El Psy Kongroo."
